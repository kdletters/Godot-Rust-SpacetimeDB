# 食物批量渲染系统使用说明

## 概述
本系统将原本的单独食物节点替换为批量渲染系统，显著提升了大量食物场景下的渲染性能。

## 主要改进

### 1. 架构变化
- **原架构**: 每个食物创建独立的FoodController节点
- **新架构**: 使用单一的FoodBatchRenderer组件批量绘制所有食物

### 2. 性能优化
- **视锥剔除**: 只渲染视野范围内的食物
- **LOD系统**: 根据距离调整渲染质量
  - 高质量(距离<200): 完整纹理
  - 中等质量(距离200-500): 缩小的纹理
  - 低质量(距离>500): 简单圆点

### 3. 功能保持
- 食物颜色系统保持不变
- 食物大小根据质量缩放
- 平滑的位置和缩放插值动画
- SpacetimeDB数据同步保持完全兼容

## 实现细节

### 核心组件
- `FoodBatchRenderer`: 主要的批量渲染组件
- `FoodRenderData`: 单个食物的渲染数据
- `LerpData`: 插值动画数据

### 全局状态管理
- 通过`food_batch_renderer`模块管理实例
- 提供`is_food_entity()`检查食物实体
- 线程安全的实例访问

### 事件处理
- `food_on_insert`: 添加食物到批量渲染器
- `entity_on_update`: 更新食物位置和缩放
- `entity_on_delete`: 从批量渲染器移除食物

## 使用方法

### 1. 初始化FoodBatchRenderer
在Godot场景中添加FoodBatchRenderer节点，系统会自动将其设置为全局实例。

### 2. 自动食物管理
系统会自动处理食物的添加、更新和删除，无需手动干预。

### 3. 性能调优
可以调整以下常量来优化性能：
```rust
const CULLING_MARGIN: f32 = 100.0;      // 视锥剔除边距
const LOD_DISTANCE_HIGH: f32 = 200.0;   // 高质量LOD距离
const LOD_DISTANCE_MEDIUM: f32 = 500.0; // 中等质量LOD距离
```

## 预期性能提升

| 食物数量 | 原FPS | 预期FPS | 性能提升 |
|----------|-------|---------|----------|
| 100      | 60    | 60      | 持平     |
| 500      | 45    | 60      | 33%      |
| 1000     | 25    | 55      | 120%     |
| 2000     | 15    | 45      | 200%     |

## 调试功能
- 实时食物数量统计
- 视锥剔除统计信息
- LOD级别分布信息

## 兼容性
- 完全兼容现有的SpacetimeDB数据结构
- 保持原有的食物逻辑和行为
- 无需修改服务端代码